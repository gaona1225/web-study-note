<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>高级DOM技术</title>
<script type="text/javascript" src="eventutil.js"></script>
<script type="text/javascript" src="listutil.js"></script>
<style>

</style>
</head>

<body>
	<form method="post" action="handlepost.php" name="formName" id="formID">
		<label for="txtName">Name:</label><br/>
		<input type="text" id="txtName" name="txtName" placeholder="zhangsan" maxlength="6"  data-invalidchars="0123456789" /><br/>
		
		<label for="txtPassword">Password:</label><br/>
		<input type="text" id="txtPassword" name="txtPassword" max="200" min="99" placeholder="password" data-validchars="0123456789" /><br/>
		
		<label for="txtComments">Comments:</label><br/>
		<textarea rows="10" cols="50" id="txtComments" name="txtComments" maxlength="20">placeholder</textarea><br/>
		
		<label for="color">color:</label><br/>
		<input type="text" id="color" name="color" placeholder="color" /><br/>
		<select id="lstColors" size="5" style="width:200px"></select>
	</form>
	<script>		
		var TextUtil = new Object();
		//限制textarea的字符数
		TextUtil.isNotMax = function(oTextarea){
			return oTextarea.value.length != oTextarea.getAttribute('maxlength') ;
		}
		
		//阻止文本框中的字符
		TextUtil.blockChars = function(oTextbox,event){
			event = EventUtil.formatEvent(event);
			var sInvalidChars = oTextbox.getAttribute('data-invalidchars');
			var sChar = String.fromCharCode(event.charCode);
			var bIsValidChar = sInvalidChars.indexOf(sChar) == -1 ;
			return bIsValidChar || event.ctrlKey ;
		}
		
		//检测黏贴的内容是否是阻止的字符
		TextUtil.blurBlock = function(oTextbox){
			var sInvalidChars = oTextbox.getAttribute('data-invalidchars');
			var arrInvalidChars = sInvalidChars.split('') ;
			
			for(var i=0;i<arrInvalidChars.length;i++){
				if(oTextbox.value.indexOf(arrInvalidChars[i])>-1){
					alert('Character ' + arrInvalidChars[i] + ' not allowed.');
					oTextbox.focus();
					oTextbox.select();
					return ;
				}
			}
		}
		
		//允许文本框中的字符
		TextUtil.allowChars = function(oTextbox,event){
			event = EventUtil.formatEvent(event);
			var sInvalidChars = oTextbox.getAttribute('data-validchars');
			var sChar = String.fromCharCode(event.charCode);
			var bIsValidChar = sInvalidChars.indexOf(sChar) > -1 ;
			return bIsValidChar || event.ctrlKey ;
		}
		
		//检测黏贴的内容是否是允许的字符
		TextUtil.blurAllow = function(oTextbox){
			var sInvalidChars = oTextbox.getAttribute('data-validchars');
			var arrInvalidChars = oTextbox.value.split('') ;
			
			for(var i=0;i<arrInvalidChars.length;i++){
				if(oTextbox.value.indexOf(arrInvalidChars[i]) == -1){
					alert('Character ' + arrInvalidChars[i] + ' not allowed.');
					oTextbox.focus();
					oTextbox.select();
					return ;
				}
			}
		}
		
		//使用上下键操作数字文本
		TextUtil.numericScroll = function(oTextbox,event){
			event = EventUtil.formatEvent(event);
			var iValue = oTextbox.value.length == 0 ? 0 : parseInt(oTextbox.value);
			var iMax = oTextbox.getAttribute('max');
			var iMin = oTextbox.getAttribute('min');
			
			if(event.keyCode == 38){
				if(iMax == null || iValue<parseInt(iMax)){
					oTextbox.value = iValue + 1 ;
				}
			}else if(event.keyCode == 40){
				if(iMin == null || iValue>parseInt(iMin)){
					oTextbox.value = iValue - 1 ;
				}
			}
		}
		
		//匹配
		TextUtil.autosuggestMatch = function(sText,arrValues){
			var arrResult = new Array();
			if(sText != ''){
				for(var i=0;i<arrValues.length;i++){
					if(arrValues[i].indexOf(sText)==0){
						arrResult.push(arrValues[i]);
					}
				}
			}
			return arrResult ;
		}
		
		//匹配内部机制
		TextUtil.autosuggest = function(oTextbox,arrValues,sListboxId){
			var oListbox = document.getElementById(sListboxId);
			ListUtil.clear(oListbox);
			
			var arrMatches = TextUtil.autosuggestMatch(oTextbox.value,arrValues);
			for(var i=0;i<arrMatches.length;i++){
				ListUtil.add(oListbox,arrMatches[i]);
			}
		}
		
		//设置匹配值
		TextUtil.setText = function(oListbox,sTextboxId){
			var oTextbox = document.getElementById(sTextboxId);
			if(oListbox.selectedIndex>-1){
				oTextbox.value = oListbox.options[oListbox.selectedIndex].text;
			}
		}
		
		//调用
		var _textarea = document.getElementById('txtComments') ;
		_textarea.onkeypress = function(){
			return TextUtil.isNotMax(this);  //阻止默认行为的原始方法，如果文本长度小于maxlength 返回true，keypress可以继续触发，大于返回false 阻止keypress方法继续触发
		};
		
		var _txtName = document.getElementById('txtName') ;
		_txtName.onkeypress = function(){
			console.log('aa');
			return TextUtil.blockChars(this,event);  
		};
		_txtName.onblur = function(){
			return TextUtil.blurBlock(this);  
		};
		
		var _txtPassword = document.getElementById('txtPassword') ;
		_txtPassword.onkeypress = function(){
			return TextUtil.allowChars(this,event);  
		};
		_txtPassword.onkeydown = function(){
			TextUtil.numericScroll(this,event);
		};
		_txtPassword.onblur = function(){
			return TextUtil.blurAllow(this);  
		};
		
		var _color = document.getElementById('color');
		var _select = document.getElementById('lstColors');
		var arrColors = ['red','orange','yellow','green','blue','raa','rbv'] ;
		arrColors.sort();
		_color.onkeyup = function(){
			TextUtil.autosuggest(this,arrColors,'lstColors');
		}
		_select.onclick = function(){
			TextUtil.setText(this,'color');
		}
	</script>
</body>
</html>
