<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0;">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>search</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="" id="skinCss" />
<script type="text/javascript" src="js/pandora.js"></script>
<script type="text/javascript" src="js/dom.js"></script>
<script type="text/javascript" src="js/event.js"></script>
<script type="text/javascript" src="js/ajax.js"></script>
<script language="javascript" type="text/javascript" src="js/base.js"></script>
<script>
var url=location.search;  

function getSearch(url){
	var request = {}, str='',strs=[], strsSplit=[]; 
	if(url.indexOf("?")!=-1){ 
		str = url.substr(1);
		strs = str.split("&"); 
		for(var i = 0, strsLen = strs.length; i<strsLen; i++){ 
			strsSplit = strs[i].split("=");
			request[ strsSplit[0]] = strsSplit[1]; 
		}
	}
	return request;
}
var req = getSearch(url),searchKey= req['searchKey'];


//搜索的内容放cookie
function getCookie(){
	var strCookie = document.cookie ; 
	var arrCookie=strCookie.split("; ") ; 
	var cookieKey = "",cookieKeyA = []; 
	for(var i=0 ;i< arrCookie.length ; i++ ){ 
		var arr= arrCookie[i].split("="); 
		if("cookieKey"==arr[0]){
			cookieKey = arr[1];
			cookieKeyA = cookieKey?cookieKey.split(","):[];
			break;
		}
	};
	return cookieKeyA;
}


//搜索的ajax
function searchAjax(key){
	$.ajax({
		url : "http://10.6.210.229:8080/wiki/search?appId=1&key="+ key,
		success : function(result) {
			console.log(result);
			var datas = result['page']['datas'],content='',datasLen = datas.length;
			if(datasLen > 0){
				for(var i=0,len=datasLen;i<len;i+=1){
					content += '<section class="search_list">'
							+'<a href="question.html?appId=1&cid='+ datas[i]['categoryId'] +'&qid='+ datas[i]['id'] +'&accessToken=a">'
							+'<h3>'+ datas[i]['content'] +'</h3>'
							+'<div>'+ datas[i]['content'] +'</div>'
							+'<p class="section_tag"><span>'+ datas[i]['userName'] +'</span><span>'+ datas[i]['address'] +'</span><span class="tag_time">'+ datas[i]['createTime'] +'</span></p>'
							+'</a>'
							+'</section>';
				}
				document.getElementById("search_con").innerHTML = content;
			}else{
				document.getElementById("search_con").innerHTML = "未搜索到相关内容！";
			}
			
			_inputClose.style.visibility = 'hidden' ;	
			_clearBtn.style = 'inline-block' ;
			_searchResult.style.height = '0px';	
		},
		type : 'json'
	});
}

var u = navigator.userAgent ;

if(u.indexOf('Android') > -1){
	document.write("<script lanague=\"javascript\" src=\"www/android/www/cordova.js\"><\/scri"+"pt>") 
	
}else if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){

	document.write("<script lanague=\"javascript\" src=\"www/ios/www/cordova-incl.js\"><\/scri"+"pt>") ;
}

function webBack(){
	if(u.indexOf('Android') > -1){
		webViewApi.goBack(success,onFail);
	}else if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
	 	webContrl.goBack(nativePluginResultHandler, nativePluginErrorHandler);
	}
}
//android返回回调
function onFail(message) {
      alert('Failed because: ' + message);
}
    
function success() {
      //todo 
}

//返回方法回调
function nativePluginResultHandler (result) {
    
}

function nativePluginErrorHandler (error) {
    
}

window.addEventListener('load',function(){
	
	var cookies = getCookie();	 
	//从url获取到searchKey字段不为空，则搜索searchKey；
	if(searchKey){
		searchAjax(searchKey);
	}
	
	document.getElementById('back_btn').addEventListener('click',function(){
		//todo
		//phonegap 程序
		//功能： 页面回退到首页
		webBack();
	},false);

	var _inputSea = document.getElementById('input_text'),
	_inputClose = document.getElementById('input_close'),
	_touchend = ('ontouchend' in document) ? 'touchend' : 'mouseup',
	_searchResult = document.getElementById('search_record_con'),
	_searchRecord = document.getElementById('search_record'),
	_searchBtn = document.getElementById('search_btn'),
	_clearBtn = document.getElementById('clearSearch') ;
		
	
	//监听输入框得到焦点，和失去焦点。	
	_inputSea.onfocus = function(){
		if(cookies.length > 0){
			var content = '',len;
			len= (cookies.length > 11)?10:cookies.length;
			for(var i=0; i<len; i++){
				content+= '<li>'
						+ '<a href="search2.html?searchKey='+ cookies[i] +'">'
						+ cookies[i]
						+'</a>'
						+'</li>';
				
			}
			_searchRecord.innerHTML = content ;
			_searchResult.style.height = '360px' ;
			_searchResult.style.visibility = 'visible' ;	
		}
	} ;
		
	//监听输入框得到焦点，和失去焦点。
	_inputSea.onblur = function(){
		 window.setTimeout(function(){
			_searchResult.style.height = '0px' ;
			_searchResult.style.visibility = 'hidden' ;	 
		},200);
	};
	
	//点击输入框内的删除按钮，删除输入框内的搜索文字；
	_inputClose.onclick = function(){
		_inputSea.value = '';
		_inputClose.style.display = 'none';
	}
		
	//监听输入框内值得变化，没有值时，隐藏输入框内的删除按钮。
	_inputSea.addEventListener('input',function(){
		if(document.getElementById('input_text').value){
			_inputClose.style.display = 'inline-block';
		}else{
			_inputClose.style.display = 'none';
		}
	},false);
		
	//清除缓存的搜索数据
	_clearBtn.addEventListener('click',function(){
		document.cookie = "cookieKey=";
	},false);
	
	//搜索按钮点击后，开始搜索
	_searchBtn.onclick = function(){
		var key = document.getElementById('input_text').value;
		if(key){
			var cookies = getCookie();
			cookies.unshift(key);
			document.cookie = "cookieKey="+cookies.toString();
		}
		if( key ){
			searchAjax(key);
		}
	}
},false)
</script>
</head>
<body>
    <header class="header">
        <a href="javascript:;" class="back_btn" id="back_btn"></a>
        <h1>百科问答</h1>
    </header>
   	
    <div class="search">
        <div class="search_input">
        	<input type="text" placeholder="搜索答案" id="input_text"/>
            <i class="input_close" id="input_close" style=" display:none; visibility:visible"></i>
        </div>
        <div class="search_btn" id="search_btn"><span></span></div>
    </div>
    <div class="search_record_con" id="search_record_con">
    	<ul class="search_record" id="search_record">
           	 
        </ul>
        <div class="search_clear" id="clearSearch"><a><i></i>清除搜索记录</a></div>
    </div> 
    <div class="search_con" id="search_con">
    	 
    </div>

</body>
</html>