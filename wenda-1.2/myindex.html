<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0;">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>myindex</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link rel="stylesheet" href="css/common.css" />
<link rel="stylesheet" href="" id="skinCss" />
<script type="text/javascript" src="js/pandora.js"></script>
<script type="text/javascript" src="js/dom.js"></script>
<script type="text/javascript" src="js/event.js"></script>
<script type="text/javascript" src="js/ajax.js"></script>
<script language="javascript" type="text/javascript" src="js/base.js"></script>
</head>
<body>
    <header class="header">
        <a href="javascript:;" class="back_btn" id="backBtn"></a>
        <h1>我的主页</h1>
        <a href="javascript:;" class="log_off">注销</a>
    </header>
   <div class="my_index">
        <div class="my_msg" id="my_msg">
        	<!--<div class="my_photo"><a href="javascript:;" class="my_msg_nophoto"><i></i></a></div>
        	<div class="my_photo" style="display:none;"><img src="img/test.png" /></div>
            <div class="my_info">
            	<p>游雄BB2014<i id="modifyNick"></i></p>
            	<p>贡献值：<span>20</span></p>
            </div>-->
        </div>
        <ul class="my_list">
        	<li><a href="myinformation.html?appId=1&accessToken=a&tabNum=0" id="myIndexMsg"><i class="my_list_info"></i>我的信息<span id="newMsg"></span></a></li>
        	<li><a href="myinformation.html?appId=1&accessToken=a&tabNum=1"><i class="my_list_ques"></i>我的提问</a></li>
        	<li><a href="myinformation.html?appId=1&accessToken=a&tabNum=2"><i class="my_list_ans"></i>我的回答</a></li>
        </ul>
   </div>
   <div class="evaluate_pop" id="popBox">
    	<div class="evaluate_pop_msg modify_nick"><span>你修改的昵称是：</span><input type="text" value="" id="nick" /></div>
    	<div class="evaluate_pop_tool"><a href="#" class="left_pop_btn" id="cancelBtn">取消</a><a href="#" class="right_pop_btn" id="okBtn">确定</a></div>
   </div>
   <div class="pop_mask" id="popMask"></div>
   <script language="javascript">
   var u = navigator.userAgent ;
   	if(u.indexOf('Android') > -1){
    	document.write("<script lanague=\"javascript\" src=\"www/android/www/cordova.js\"><\/scri"+"pt>") 
	}else if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
	    document.write("<script lanague=\"javascript\" src=\"www/ios/www/cordova-incl.js\"><\/scri"+"pt>") ;
	}
   		
   		function webBack(){
			if(u.indexOf('Android') > -1){
				webViewApi.goBack(success,onFail);
			}else if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
			 	webContrl.goBack(nativePluginResultHandler, nativePluginErrorHandler);
			}
		}
		//android返回回调
		function onFail(message) {
		      alert('Failed because: ' + message);
		}
		    
		function success() {
		      //todo 
		}

		//返回方法回调
		function nativePluginResultHandler (result) {
    
		}

		function nativePluginErrorHandler (error) {
    
		}
		
   		document.getElementById('backBtn').onclick = function(){
			//TODO phonegap 返回
			webBack();
		}
		
   		var url=location.search; 
		function getSearch(url){
			var request = {}, str='',strs=[], strsSplit=[]; 
			if(url.indexOf("?")!=-1){ 
				str = url.substr(1);
				strs = str.split("&"); 
				for(var i = 0, strsLen = strs.length; i<strsLen; i++){ 
					strsSplit = strs[i].split("=");
					request[ strsSplit[0]] = strsSplit[1]; 
				}
			}
			return request;
		}
		var req = getSearch(url),qid = req['qid'] ,pics = [];
		
   		var uid = 111111 ;
   		var accessToken = 'a' ;
		var source = 1 ;
		var popBox = document.getElementById('popBox') ;
		var popMask = document.getElementById('popMask') ;
		ajaxload() ;
		loadNewMsg() ;		
		
   		function ajaxload(){
			$.ajax({
				url : 'http://10.6.210.229:8080/wiki/getUser?accessToken=' + accessToken + '&source=' + source + '&uid=' + uid ,
				success : function(result) {					
					var user = result['user'] ;
					var pic = user['logo'] ;
					var my_msg = '',photo = '',modify = '';
					//console.log(users[0]) ;
					if(user){
						if(pic){
							photo = '<img src="' + pic + '" />' ;
						}else{
							photo = '<a href="javascript:;" class="my_msg_nophoto"><i></i></a>' ;
						}
						if(user['nun'] == 0){
							modify += '<i id="modifyNick"></i>' ;
						}
						my_msg += '<div class="my_photo">' + photo + '</div>'
								+ '<div class="my_info">'
								+ '<p id="my_nick">' + user['nick'] + modify + '</p>'
								+ '<p>贡献值：<span>' + user['integral'] + '</span></p>'
								+ '</div>' ;
					}
					document.getElementById('nick').value = user['nick'] ;
					document.getElementById('nick').setAttribute('data-value',user['nick']) ;
					document.getElementById('my_msg').innerHTML = my_msg ;
					if(document.getElementById('modifyNick')){
						document.getElementById('modifyNick').onclick = function(){
							popBox.style.display = 'block' ;
							popMask.style.display = 'block' ;
						}
					}
				},
				type : 'json'
			});
		}
		
		function loadNewMsg(){
			$.ajax({
				url : 'http://10.6.210.229:8080/wiki/newMessage?accessToken=' + accessToken ,
				success : function(result) {	
					console.log(result['num']) ;				
					var newNum = result['num'] ;
					if(newNum>0){						
						document.getElementById('newMsg').innerHTML = '<span class="mes_num">' +newNum + '</span>' ;
					}else{
						document.getElementById('newMsg').innerHTML = '' ;
					}
				},
				type : 'json'
			});
		}
		
		document.getElementById('cancelBtn').onclick = function(){
			popBox.style.display = 'none' ;
			popMask.style.display = 'none' ;
		}
		
		document.getElementById('okBtn').onclick = function(){
			popBox.style.display = 'none' ;
			popMask.style.display = 'none' ;
			var newNick = document.getElementById('nick').value ;
			if( newNick != document.getElementById('nick').getAttribute('data-value') && newNick != ''){
				submitMes(newNick) ;
			}
		}
		
		function submitMes(newNick){
			console.log(newNick) ;
			$.ajax({
				url :'http://10.6.210.229:8080/wiki/updateUser?accessToken=a&id=aaaaaa&nick=' + newNick ,
				success: function(result){
					console.log(result) ;
					ajaxload() ;
				},
				type : 'json'
			}) ;
		}
   </script>
</body>
</html>